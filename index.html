<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Smart Outreach Generator </title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root{--bg:#0a0a0f;--panel:#111827;--muted:#9ca3af;--text:#f3f4f6;--brand:#3b82f6;--accent:#8b5cf6;--success:#10b981;--warning:#f59e0b;--danger:#ef4444;--surface:#1f2937}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,sans-serif;background:linear-gradient(135deg,#0a0a0f 0%,#111827 50%,#0a0a0f 100%);color:var(--text);min-height:100vh}
  .container{max-width:1400px;margin:0 auto;padding:24px}
  
  .header{text-align:center;margin-bottom:32px}
  .logo{display:inline-flex;align-items:center;gap:12px;margin-bottom:16px}
  .logo-icon{width:48px;height:48px;background:linear-gradient(135deg,var(--brand),var(--accent));border-radius:12px;display:grid;place-items:center;font-weight:900;color:white;font-size:20px}
  h1{font-size:clamp(24px,4vw,36px);margin:0;background:linear-gradient(135deg,var(--brand),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
  .subtitle{color:var(--muted);margin:8px 0 0;font-size:16px}
  
  .main-grid{display:grid;grid-template-columns:1fr 400px;gap:24px;margin-bottom:24px}
  .panel{background:rgba(17,24,39,0.8);backdrop-filter:blur(10px);border:1px solid rgba(55,65,81,0.5);border-radius:16px;padding:24px}
  
  .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:20px}
  .form-group{display:flex;flex-direction:column;gap:6px}
  label{font-size:12px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px}
  input,select,textarea{width:100%;padding:12px 16px;border:1px solid rgba(55,65,81,0.6);border-radius:10px;background:var(--surface);color:var(--text);font:inherit;transition:all 0.2s ease}
  input:focus,select:focus,textarea:focus{outline:none;border-color:var(--brand);box-shadow:0 0 0 3px rgba(59,130,246,0.1)}
  textarea{min-height:100px;resize:vertical}
  
  .upload-area{border:2px dashed rgba(55,65,81,0.6);border-radius:12px;padding:32px;text-align:center;transition:all 0.3s ease;cursor:pointer}
  .upload-area:hover{border-color:var(--brand);background:rgba(59,130,246,0.05)}
  .upload-area.dragover{border-color:var(--brand);background:rgba(59,130,246,0.1)}
  
  .filters{display:flex;flex-wrap:wrap;gap:12px;margin:16px 0}
  .filter-chip{display:flex;align-items:center;gap:8px;padding:8px 16px;border-radius:20px;background:rgba(55,65,81,0.5);border:1px solid rgba(55,65,81,0.8);font-size:14px;cursor:pointer;transition:all 0.2s ease}
  .filter-chip:hover{background:rgba(55,65,81,0.7)}
  .filter-chip.active{background:rgba(59,130,246,0.2);border-color:var(--brand);color:var(--brand)}
  
  .btn{padding:12px 24px;border:none;border-radius:10px;font:inherit;font-weight:600;cursor:pointer;transition:all 0.2s ease;text-decoration:none;display:inline-flex;align-items:center;gap:8px;justify-content:center}
  .btn-primary{background:linear-gradient(135deg,var(--brand),var(--accent));color:white}
  .btn-primary:hover{transform:translateY(-1px);box-shadow:0 8px 25px rgba(59,130,246,0.3)}
  .btn-secondary{background:transparent;border:1px solid rgba(55,65,81,0.8);color:var(--text)}
  .btn-secondary:hover{background:rgba(55,65,81,0.3)}
  .btn:disabled{opacity:0.5;cursor:not-allowed;transform:none!important}
  
  .stats{display:flex;gap:16px;margin:16px 0;flex-wrap:wrap}
  .stat{background:rgba(55,65,81,0.3);padding:12px 16px;border-radius:8px;text-align:center;min-width:120px}
  .stat-number{font-size:20px;font-weight:700;color:var(--brand)}
  .stat-label{font-size:12px;color:var(--muted);margin-top:4px}
  
  .results{margin-top:24px}
  .result-card{background:rgba(17,24,39,0.9);border:1px solid rgba(55,65,81,0.5);border-radius:12px;padding:20px;margin-bottom:16px;transition:all 0.3s ease}
  .result-card:hover{border-color:rgba(59,130,246,0.5);box-shadow:0 8px 25px rgba(0,0,0,0.2)}
  
  .card-header{display:flex;justify-content:space-between;align-items:start;margin-bottom:16px;flex-wrap:wrap;gap:12px}
  .company-info h3{margin:0 0 4px;font-size:18px;color:var(--text)}
  .company-meta{font-size:12px;color:var(--muted)}
  .badges{display:flex;gap:8px;flex-wrap:wrap}
  .badge{padding:4px 12px;border-radius:16px;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px}
  .badge-industry{background:rgba(139,92,246,0.2);color:var(--accent);border:1px solid rgba(139,92,246,0.3)}
  .badge-segment{background:rgba(59,130,246,0.2);color:var(--brand);border:1px solid rgba(59,130,246,0.3)}
  .badge-danger{background:rgba(239,68,68,0.2);color:var(--danger);border:1px solid rgba(239,68,68,0.3)}
  .badge-warning{background:rgba(245,158,11,0.2);color:var(--warning);border:1px solid rgba(245,158,11,0.3)}
  .badge-success{background:rgba(16,185,129,0.2);color:var(--success);border:1px solid rgba(16,185,129,0.3)}
  
  .email-content{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
  .email-field{display:flex;flex-direction:column;gap:8px}
  .email-field label{font-size:11px;color:var(--muted)}
  .email-field input{font-size:14px;font-weight:600}
  .email-field textarea{font-size:13px;line-height:1.5;min-height:200px;font-family:ui-monospace,Monaco,Cascadia Code,Segoe UI Mono,Roboto Mono,monospace}
  
  .card-actions{display:flex;gap:8px;margin-top:16px;flex-wrap:wrap}
  .btn-sm{padding:8px 16px;font-size:13px}
  
  .insights{background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.2);border-radius:8px;padding:12px;margin-top:12px}
  .insights-title{font-weight:600;margin-bottom:8px;color:var(--brand)}
  .insights-list{font-size:13px;color:var(--muted);line-height:1.5}
  
  @media (max-width:1200px){.main-grid{grid-template-columns:1fr}}
  @media (max-width:768px){.email-content{grid-template-columns:1fr}.form-grid{grid-template-columns:1fr}}
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">
        <div class="logo-icon">SG</div>
        <div>
          <h1>Smart Outreach Generator</h1>
          <p class="subtitle">AI-powered personalized cold email generation from CSV data</p>
        </div>
      </div>
    </div>

    <div class="main-grid">
      <div class="panel">
        <h2 style="margin:0 0 20px;font-size:20px">Configuration</h2>
        
        <div class="form-grid">
          <div class="form-group">
            <label>Your Name</label>
            <input id="yourName" value="Rajat Mahajan" placeholder="Your full name"/>
          </div>
          <div class="form-group">
            <label>Your Email</label>
            <input id="yourEmail" value="rajatmaja.96@gmail.com" placeholder="your@email.com"/>
          </div>
          <div class="form-group">
            <label>CC Email (Partner)</label>
            <input id="ccEmail" placeholder="partner@email.com"/>
          </div>
          <div class="form-group">
            <label>Target Market</label>
            <input id="market" placeholder="Jaipur, Rajasthan" value="Jaipur"/>
          </div>
          <div class="form-group">
            <label>Company Name</label>
            <input id="companyName" value="VamiTech Solutions"/>
          </div>
          <div class="form-group">
            <label>Company Website</label>
            <input id="companyUrl" value="https://vamitech.in"/>
          </div>
        </div>

        <div class="form-group">
          <label>Upload CSV File</label>
          <div class="upload-area" id="uploadArea">
            <input type="file" id="csvFile" accept=".csv" style="display:none"/>
            <div>üìä Click to upload or drag & drop your CSV file</div>
            <div style="font-size:12px;color:var(--muted);margin-top:8px">Supports: Name, Email, Website, Industry, Address, Phone, Rating, Reviews, etc.</div>
          </div>
        </div>

        <div class="form-group">
          <label>Email Tone</label>
          <select id="emailTone">
            <option value="professional">Professional & Direct</option>
            <option value="friendly" selected>Friendly & Conversational</option>
            <option value="consultative">Consultative & Expert</option>
            <option value="casual">Casual & Approachable</option>
          </select>
        </div>

        <div>
          <label>Target Segments</label>
          <div class="filters">
            <div class="filter-chip active" data-filter="no-website">
              <input type="checkbox" checked> No Website
            </div>
            <div class="filter-chip active" data-filter="weak-website">
              <input type="checkbox" checked> Weak/DIY Website
            </div>
            <div class="filter-chip active" data-filter="enhance-website">
              <input type="checkbox" checked> Professional Website (Enhance)
            </div>
            <div class="filter-chip active" data-filter="poor-performance">
              <input type="checkbox" checked> Poor Online Performance
            </div>
          </div>
        </div>

        <div style="display:flex;gap:12px;margin-top:20px">
          <button id="generateBtn" class="btn btn-primary" style="flex:1">üöÄ Generate Smart Pitches</button>
          <button id="exportBtn" class="btn btn-secondary">üì• Export Results</button>
        </div>
      </div>

      <div class="panel">
        <h3 style="margin:0 0 16px">Quick Stats</h3>
        <div class="stats" id="statsContainer">
          <div class="stat">
            <div class="stat-number" id="totalCount">0</div>
            <div class="stat-label">Total Leads</div>
          </div>
          <div class="stat">
            <div class="stat-number" id="targetCount">0</div>
            <div class="stat-label">Targeted</div>
          </div>
          <div class="stat">
            <div class="stat-number" id="industryCount">0</div>
            <div class="stat-label">Industries</div>
          </div>
        </div>
        
        <div class="form-group" style="margin-top:20px">
          <label>AI Analysis Insights</label>
          <div id="aiInsights" style="background:rgba(55,65,81,0.3);border-radius:8px;padding:16px;font-size:13px;color:var(--muted);min-height:100px">
            Upload a CSV to see AI-powered insights about your leads...
          </div>
        </div>
      </div>
    </div>

    <div class="results" id="resultsContainer"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.4.1/papaparse.min.js"></script>
  <script>
    // Fallback CSV parser if Papa Parse doesn't load
    function parseCSVFallback(text) {
      const lines = text.split('\n').filter(line => line.trim());
      if (lines.length === 0) return { data: [], errors: [] };
      
      const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
      const data = [];
      
      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',').map(v => v.replace(/"/g, '').trim());
        const row = {};
        headers.forEach((header, index) => {
          row[header] = values[index] || '';
        });
        data.push(row);
      }
      
      return { data, errors: [] };
    }

    // Wait for Papa Parse to load
    function waitForPapa() {
      return new Promise((resolve) => {
        if (typeof Papa !== 'undefined') {
          resolve(true);
          return;
        }
        
        let attempts = 0;
        const checkPapa = setInterval(() => {
          attempts++;
          if (typeof Papa !== 'undefined') {
            clearInterval(checkPapa);
            resolve(true);
          } else if (attempts > 50) { // 5 seconds timeout
            clearInterval(checkPapa);
            resolve(false);
          }
        }, 100);
      });
    }
    // === Smart Outreach Generator with AI-like Analysis ===
    
    let csvData = [];
    let processedLeads = [];
    
    // Advanced industry detection with more signals
    const industrySignals = {
      restaurant: {
        keywords: ['restaurant', 'cafe', 'coffee', 'bistro', 'diner', 'pizza', 'burger', 'food', 'kitchen', 'grill', 'bakery', 'bar', 'pub', 'takeaway', 'delivery'],
        websites: ['opentable', 'resy', 'doordash', 'ubereats', 'grubhub', 'seamless', 'postmates'],
        indicators: ['menu', 'order', 'delivery', 'takeout', 'dining']
      },
      healthcare: {
        keywords: ['clinic', 'medical', 'dental', 'doctor', 'physician', 'therapy', 'hospital', 'health', 'wellness', 'physio', 'chiro', 'derma', 'cardio', 'ortho'],
        websites: ['zocdoc', 'healthgrades', 'practo', 'appointments'],
        indicators: ['appointment', 'patient', 'treatment', 'consultation']
      },
      fitness: {
        keywords: ['gym', 'fitness', 'yoga', 'pilates', 'crossfit', 'boxing', 'martial', 'wellness', 'trainer', 'workout', 'studio'],
        websites: ['mindbody', 'classpass', 'fitmind'],
        indicators: ['membership', 'classes', 'training', 'workout']
      },
      beauty: {
        keywords: ['salon', 'spa', 'beauty', 'hair', 'nails', 'massage', 'barber', 'esthetics', 'facial', 'makeup'],
        websites: ['booksy', 'fresha', 'stylecar'],
        indicators: ['appointment', 'booking', 'services', 'treatment']
      },
      realestate: {
        keywords: ['realty', 'realtor', 'real estate', 'properties', 'homes', 'housing', 'broker', 'agent'],
        websites: ['zillow', 'realtor.com', 'mls'],
        indicators: ['listings', 'properties', 'homes', 'sales']
      },
      retail: {
        keywords: ['shop', 'store', 'boutique', 'retail', 'market', 'goods', 'products', 'fashion', 'clothing'],
        websites: ['shopify', 'woocommerce', 'bigcommerce', 'square'],
        indicators: ['shop', 'buy', 'products', 'inventory']
      },
      professional: {
        keywords: ['law', 'legal', 'attorney', 'accounting', 'finance', 'consulting', 'agency', 'firm', 'services'],
        websites: ['linkedin', 'lawfirm'],
        indicators: ['consultation', 'services', 'clients', 'professional']
      },
      education: {
        keywords: ['school', 'education', 'training', 'academy', 'institute', 'learning', 'tuition', 'coaching'],
        websites: ['canvas', 'blackboard', 'moodle'],
        indicators: ['courses', 'students', 'learning', 'classes']
      }
    };

    // Website quality analysis
    const weakDomains = [
      'wix.com', 'weebly.com', 'squarespace.com', 'wordpress.com', 'godaddy.com',
      'google.sites', 'mailchimp.com', 'carrd.co', 'linktree', 'bit.ly',
      'facebook.com', 'instagram.com', 'tiktok.com'
    ];

    const professionalIndicators = [
      'ssl certificate', 'https://', 'custom domain', 'responsive design',
      'seo optimized', 'google analytics', 'contact form', 'about page'
    ];

    // Smart column mapping
    function mapColumns(headers) {
      const mapping = {};
      const patterns = {
        name: ['name', 'business', 'company', 'title', 'business name', 'company name'],
        email: ['email', 'e-mail', 'contact', 'business email', 'contact email'],
        website: ['website', 'url', 'site', 'web', 'link', 'domain'],
        phone: ['phone', 'telephone', 'mobile', 'contact number'],
        address: ['address', 'location', 'city', 'state', 'region'],
        industry: ['industry', 'category', 'type', 'business type', 'sector'],
        rating: ['rating', 'score', 'google rating', 'review score'],
        reviews: ['reviews', 'review count', 'google reviews', 'number of reviews'],
        description: ['description', 'about', 'bio', 'summary']
      };

      for (const [field, candidates] of Object.entries(patterns)) {
        const match = headers.find(h => 
          candidates.some(c => h.toLowerCase().includes(c.toLowerCase()))
        );
        if (match) mapping[field] = match;
      }

      return mapping;
    }

    // Detect industry with advanced analysis
    function detectIndustry(record, mapping) {
      const textToAnalyze = [
        record[mapping.name] || '',
        record[mapping.description] || '',
        record[mapping.website] || '',
        record[mapping.industry] || ''
      ].join(' ').toLowerCase();

      let bestMatch = 'general';
      let bestScore = 0;

      for (const [industry, signals] of Object.entries(industrySignals)) {
        let score = 0;
        
        // Keyword matching
        signals.keywords.forEach(keyword => {
          if (textToAnalyze.includes(keyword)) score += 2;
        });
        
        // Website integration signals
        if (record[mapping.website]) {
          signals.websites.forEach(site => {
            if (textToAnalyze.includes(site)) score += 3;
          });
        }
        
        // Business indicators
        signals.indicators.forEach(indicator => {
          if (textToAnalyze.includes(indicator)) score += 1;
        });

        if (score > bestScore) {
          bestScore = score;
          bestMatch = industry;
        }
      }

      return bestMatch;
    }

    // Analyze website quality and opportunities
    function analyzeWebsite(url, record, mapping) {
      if (!url) return { segment: 'no-website', issues: ['No online presence'], opportunities: ['Complete digital foundation'] };

      url = url.trim();
      if (!url.startsWith('http')) url = 'https://' + url;

      try {
        const urlObj = new URL(url);
        const domain = urlObj.hostname.toLowerCase();
        
        let segment = 'professional';
        let issues = [];
        let opportunities = [];
        let signals = [];

        // Check for weak domains
        if (weakDomains.some(weak => domain.includes(weak))) {
          segment = 'weak-website';
          issues.push('Using DIY/template platform');
          opportunities.push('Custom professional website');
        }

        // Analyze other signals
        const rating = parseFloat(record[mapping.rating]) || 0;
        const reviewCount = parseInt(record[mapping.reviews]) || 0;

        if (rating && rating < 4.0) {
          issues.push(`Low rating (${rating}‚≠ê)`);
          opportunities.push('Reputation management system');
        }

        if (reviewCount && reviewCount < 50) {
          issues.push('Limited social proof');
          opportunities.push('Review generation strategy');
        }

        // Check for modern features (simulated analysis)
        const hasModernFeatures = Math.random() > 0.6; // Simulate detection
        if (!hasModernFeatures) {
          issues.push('Missing modern web features');
          opportunities.push('Performance optimization', 'Mobile responsiveness');
        }

        return { segment, issues, opportunities, signals };
      } catch {
        return { segment: 'invalid-website', issues: ['Invalid website URL'], opportunities: ['Proper domain setup'] };
      }
    }

    // Generate personalized subject lines
    function generateSubjects(lead, analysis) {
      const { name, industry, segment } = lead;
      const city = extractCity(lead.address);
      const subjects = [];

      const templates = {
        'no-website': [
          `${name}: Ready to go digital?`,
          `Quick question about ${name}'s online presence`,
          `${name} ‚Üí Missing 73% of potential customers?`,
          `Digital foundation for ${name}${city ? ` in ${city}` : ''}`,
          `${name}: Your competitors are online, are you?`
        ],
        'weak-website': [
          `${name}: Time to ditch the template?`,
          `Professional upgrade for ${name}?`,
          `${name}: Your website vs your competition`,
          `Quick wins for ${name}'s digital presence`,
          `${name}: Ready for a real website?`
        ],
        'professional': [
          `${name}: 3 quick improvements we spotted`,
          `Conversion opportunities for ${name}`,
          `${name}: Small changes, big impact`,
          `Quick audit results for ${name}`,
          `${name}: Performance optimization opportunity`
        ]
      };

      // Industry-specific subjects
      const industryTemplates = {
        restaurant: [
          `${name}: Direct ordering = higher margins`,
          `${name}: Reduce commission fees by 15%`,
          `Table reservations for ${name}?`
        ],
        healthcare: [
          `${name}: Online appointment booking?`,
          `Patient experience upgrade for ${name}`,
          `${name}: Reduce no-shows by 40%`
        ],
        fitness: [
          `${name}: Class booking automation`,
          `Member retention system for ${name}`,
          `${name}: Digital membership experience`
        ],
        beauty: [
          `${name}: Automated booking & reminders`,
          `${name}: Showcase your work online`,
          `Client management system for ${name}`
        ]
      };

      // Add segment-based subjects
      if (templates[segment]) {
        subjects.push(...templates[segment]);
      }

      // Add industry-specific subjects
      if (industryTemplates[industry]) {
        subjects.push(...industryTemplates[industry]);
      }

      // Return randomized selection
      return subjects.sort(() => Math.random() - 0.5).slice(0, 3);
    }

    // Generate personalized email body
    function generateEmailBody(lead, analysis, config) {
      const { name, industry, segment, website, rating, reviews, address } = lead;
      const { issues, opportunities } = analysis;
      const city = extractCity(address);
      
      const intros = {
        professional: `Hi there,\n\nI've been researching ${industry} businesses${city ? ` in ${city}` : ''} and ${name} caught my attention.`,
        friendly: `Hey!\n\nI was browsing ${industry} businesses${city ? ` around ${city}` : ''} and came across ${name}. Really liked what I saw!`,
        consultative: `Hello,\n\nI specialize in helping ${industry} businesses grow their digital presence. After reviewing ${name}, I see some interesting opportunities.`,
        casual: `Hi!\n\nI've been checking out local ${industry} spots${city ? ` in ${city}` : ''} and ${name} looks great!`
      };

      const problemStatements = {
        'no-website': `Right now, you're missing out on customers who search online first (which is about 80% of people these days).`,
        'weak-website': `Your current site might be holding you back from reaching your full potential.`,
        'professional': `Your website is solid, but I spotted a few areas where small changes could make a big impact.`,
        'poor-performance': `Your online presence has room for improvement that could drive real business results.`
      };

      const solutions = {
        restaurant: [
          'üçΩÔ∏è Direct online ordering (skip the commission fees)',
          'üìÖ Table reservation system',
          '‚≠ê Review management & reputation building',
          'üì± Mobile-first design for on-the-go customers',
          'üîç Local SEO to appear in "restaurants near me"'
        ],
        healthcare: [
          'üìÖ Online appointment booking & scheduling',
          'üì± Patient portal for forms and communications',
          'üîç Local medical SEO optimization',
          '‚≠ê Review management for trust building',
          'üìä Analytics to track patient acquisition'
        ],
        fitness: [
          'üìÖ Class booking and membership management',
          'üí™ Showcase facilities and trainer profiles',
          'üì± Member app integration',
          '‚≠ê Success stories and testimonials',
          'üîç Local fitness SEO optimization'
        ],
        beauty: [
          'üíÖ Online booking for all services',
          'üì∏ Portfolio showcase (before/after)',
          'üìÖ Automated reminders and follow-ups',
          '‚≠ê Review collection and management',
          'üéØ Social media integration'
        ],
        general: [
          'üåê Professional website design & development',
          'üîç Search engine optimization (SEO)',
          'üì± Mobile-responsive design',
          'üìä Analytics and performance tracking',
          '‚≠ê Online reputation management'
        ]
      };

      const personalTouches = [];
      if (rating && rating >= 4.5) personalTouches.push(`Love that you have a ${rating}‚≠ê rating!`);
      if (reviews && reviews > 100) personalTouches.push(`Impressive ${reviews} reviews shows real customer satisfaction.`);
      if (website && segment === 'professional') personalTouches.push(`Your current site has good bones.`);

      const solutionSet = solutions[industry] || solutions.general;
      const selectedSolutions = solutionSet.slice(0, 4);

      let body = intros[config.tone] + '\n\n';
      
      if (personalTouches.length > 0) {
        body += personalTouches[0] + ' ';
      }
      
      body += problemStatements[segment] + '\n\n';
      body += `Here's what we could help ${name} with:\n\n`;
      body += selectedSolutions.join('\n') + '\n\n';
      
      if (opportunities.length > 0) {
        body += `Quick wins I see for ${name}:\n`;
        body += opportunities.slice(0, 3).map(opp => `‚Ä¢ ${opp}`).join('\n') + '\n\n';
      }

      body += `Would love to show you a quick mockup of what this could look like for ${name}. `;
      body += `Mind if I put together a 5-minute demo?\n\n`;
      body += `Best regards,\n${config.yourName}\n${config.companyName}\n${config.companyUrl}`;
      
      if (config.ccEmail) {
        body += `\n\nCC: ${config.ccEmail}`;
      }

      return body;
    }

    // Extract city from address
    function extractCity(address) {
      if (!address) return '';
      const patterns = [
        /([A-Za-z\s]+),\s*[A-Z]{2}/, // City, ST
        /([A-Za-z\s]+),\s*[A-Za-z\s]+$/, // City, State
        /^([A-Za-z\s]+)/ // Just first part
      ];
      
      for (const pattern of patterns) {
        const match = address.match(pattern);
        if (match) return match[1].trim();
      }
      return '';
    }

    // Process CSV data with smart analysis
    function processCSV(data) {
      if (!data || data.length === 0) return [];
      
      const headers = Object.keys(data[0]);
      const mapping = mapColumns(headers);
              const processed = [];

      for (const record of data) {
        const name = (record[mapping.name] || '').trim();
        if (!name) continue;

        const industry = detectIndustry(record, mapping);
        const website = (record[mapping.website] || '').trim();
        const analysis = analyzeWebsite(website, record, mapping);

        const lead = {
          name,
          email: (record[mapping.email] || '').trim(),
          website,
          phone: (record[mapping.phone] || '').trim(),
          address: (record[mapping.address] || '').trim(),
          industry,
          rating: parseFloat(record[mapping.rating]) || null,
          reviews: parseInt(record[mapping.reviews]) || null,
          description: (record[mapping.description] || '').trim(),
          segment: analysis.segment
        };

        processed.push({ lead, analysis });
      }

      return processed;
    }

    // Render results
    function renderResults(data) {
      const resultsContainer = document.getElementById('resultsContainer');
      resultsContainer.innerHTML = '';

      if (data.length === 0) {
        resultsContainer.innerHTML = '<div class="panel"><p>No leads match your current filters.</p></div>';
        return;
      }

      const config = {
        yourName: document.getElementById('yourName').value.trim(),
        yourEmail: document.getElementById('yourEmail').value.trim(),
        ccEmail: document.getElementById('ccEmail').value.trim(),
        companyName: document.getElementById('companyName').value.trim(),
        companyUrl: document.getElementById('companyUrl').value.trim(),
        tone: document.getElementById('emailTone').value
      };

      data.forEach((item, index) => {
        const { lead, analysis } = item;
        const subjects = generateSubjects(lead, analysis);
        const emailBody = generateEmailBody(lead, analysis, config);

        const card = document.createElement('div');
        card.className = 'result-card';

        const segmentClass = {
          'no-website': 'badge-danger',
          'weak-website': 'badge-warning',
          'professional': 'badge-success',
          'invalid-website': 'badge-danger'
        }[lead.segment] || 'badge-segment';

        card.innerHTML = `
          <div class="card-header">
            <div class="company-info">
              <h3>${lead.name}</h3>
              <div class="company-meta">
                ${lead.website ? `<a href="${lead.website}" target="_blank">${lead.website}</a>` : 'No website'}
                ${lead.address ? ` ‚Ä¢ ${lead.address}` : ''}
                ${lead.phone ? ` ‚Ä¢ ${lead.phone}` : ''}
              </div>
            </div>
            <div class="badges">
              <span class="badge badge-industry">${lead.industry}</span>
              <span class="badge ${segmentClass}">${lead.segment.replace('-', ' ')}</span>
              ${lead.rating ? `<span class="badge badge-success">${lead.rating}‚≠ê</span>` : ''}
              ${lead.reviews ? `<span class="badge badge-success">${lead.reviews} reviews</span>` : ''}
            </div>
          </div>

          ${analysis.issues.length > 0 ? `
          <div class="insights">
            <div class="insights-title">üéØ Opportunities Detected</div>
            <div class="insights-list">
              <strong>Issues:</strong> ${analysis.issues.join(', ')}<br>
              <strong>Solutions:</strong> ${analysis.opportunities.join(', ')}
            </div>
          </div>
          ` : ''}

          <div class="email-content">
            <div class="email-field">
              <label>Subject Line (${subjects.length} variants)</label>
              <select class="subject-select">
                ${subjects.map((subj, i) => `<option value="${subj}">${subj}</option>`).join('')}
              </select>
              <input class="subject-input" value="${subjects[0]}" />
            </div>
            <div class="email-field">
              <label>Email Body</label>
              <textarea class="body-input">${emailBody}</textarea>
            </div>
          </div>

          <div class="card-actions">
            <button class="btn btn-secondary btn-sm copy-subject">üìã Copy Subject</button>
            <button class="btn btn-secondary btn-sm copy-body">üìã Copy Body</button>
            <button class="btn btn-secondary btn-sm regenerate">üîÑ Regenerate</button>
            ${lead.email ? `<a href="mailto:${lead.email}?subject=${encodeURIComponent(subjects[0])}&body=${encodeURIComponent(emailBody)}${config.ccEmail ? `&cc=${config.ccEmail}` : ''}" class="btn btn-primary btn-sm">üìß Send Email</a>` : ''}
          </div>
        `;

        // Add event listeners
        const subjectSelect = card.querySelector('.subject-select');
        const subjectInput = card.querySelector('.subject-input');
        const bodyInput = card.querySelector('.body-input');

        subjectSelect.addEventListener('change', () => {
          subjectInput.value = subjectSelect.value;
        });

        card.querySelector('.copy-subject').addEventListener('click', () => {
          navigator.clipboard.writeText(subjectInput.value);
          card.querySelector('.copy-subject').textContent = '‚úÖ Copied!';
          setTimeout(() => card.querySelector('.copy-subject').textContent = 'üìã Copy Subject', 2000);
        });

        card.querySelector('.copy-body').addEventListener('click', () => {
          navigator.clipboard.writeText(bodyInput.value);
          card.querySelector('.copy-body').textContent = '‚úÖ Copied!';
          setTimeout(() => card.querySelector('.copy-body').textContent = 'üìã Copy Body', 2000);
        });

        card.querySelector('.regenerate').addEventListener('click', () => {
          const newSubjects = generateSubjects(lead, analysis);
          const newBody = generateEmailBody(lead, analysis, config);
          
          subjectSelect.innerHTML = newSubjects.map(subj => `<option value="${subj}">${subj}</option>`).join('');
          subjectInput.value = newSubjects[0];
          bodyInput.value = newBody;
        });

        resultsContainer.appendChild(card);
      });
    }

    // Update stats
    function updateStats(data) {
      const totalCount = data.length;
      const targetCount = data.filter(item => {
        const filters = {
          'no-website': document.querySelector('[data-filter="no-website"] input').checked,
          'weak-website': document.querySelector('[data-filter="weak-website"] input').checked,
          'enhance-website': document.querySelector('[data-filter="enhance-website"] input').checked,
          'poor-performance': document.querySelector('[data-filter="poor-performance"] input').checked
        };

        const segment = item.lead.segment;
        const hasIssues = item.analysis.issues.length > 0;

        return (
          (segment === 'no-website' && filters['no-website']) ||
          (segment === 'weak-website' && filters['weak-website']) ||
          (segment === 'professional' && filters['enhance-website']) ||
          (hasIssues && filters['poor-performance'])
        );
      }).length;

      const industries = [...new Set(data.map(item => item.lead.industry))].length;

      document.getElementById('totalCount').textContent = totalCount;
      document.getElementById('targetCount').textContent = targetCount;
      document.getElementById('industryCount').textContent = industries;

      // AI Insights
      const insights = generateInsights(data);
      document.getElementById('aiInsights').innerHTML = insights;
    }

    // Generate AI insights
    function generateInsights(data) {
      if (data.length === 0) return 'Upload a CSV to see AI-powered insights...';

      const segments = data.reduce((acc, item) => {
        acc[item.lead.segment] = (acc[item.lead.segment] || 0) + 1;
        return acc;
      }, {});

      const industries = data.reduce((acc, item) => {
        acc[item.lead.industry] = (acc[item.lead.industry] || 0) + 1;
        return acc;
      }, {});

      const topIndustry = Object.entries(industries).sort((a, b) => b[1] - a[1])[0];
      const avgRating = data.filter(item => item.lead.rating).reduce((sum, item) => sum + item.lead.rating, 0) / data.filter(item => item.lead.rating).length;

      let insights = `<strong>ü§ñ AI Analysis:</strong><br><br>`;
      insights += `<strong>Target Breakdown:</strong><br>`;
      Object.entries(segments).forEach(([seg, count]) => {
        const percentage = Math.round((count / data.length) * 100);
        insights += `‚Ä¢ ${seg.replace('-', ' ')}: ${count} leads (${percentage}%)<br>`;
      });

      insights += `<br><strong>Industry Focus:</strong><br>`;
      insights += `‚Ä¢ Primary: ${topIndustry[0]} (${topIndustry[1]} leads)<br>`;

      if (avgRating) {
        insights += `<br><strong>Quality Indicators:</strong><br>`;
        insights += `‚Ä¢ Average rating: ${avgRating.toFixed(1)}‚≠ê<br>`;
      }

      insights += `<br><strong>Recommendation:</strong><br>`;
      if (segments['no-website'] > data.length * 0.4) {
        insights += `Focus on "digital foundation" messaging - many prospects lack basic web presence.`;
      } else if (segments['weak-website'] > data.length * 0.3) {
        insights += `Emphasize "professional upgrade" - many are using DIY solutions.`;
      } else {
        insights += `Target "optimization & growth" - most have established presence.`;
      }

      return insights;
    }

    // File upload handling
    const uploadArea = document.getElementById('uploadArea');
    const csvFileInput = document.getElementById('csvFile');

    uploadArea.addEventListener('click', () => csvFileInput.click());

    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        csvFileInput.files = files;
        handleFileUpload(files[0]);
      }
    });

    csvFileInput.addEventListener('change', (e) => {
      console.log('File input changed:', e.target.files);
      if (e.target.files && e.target.files.length > 0) {
        handleFileUpload(e.target.files[0]);
      }
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOM loaded, Papa Parse available:', typeof Papa !== 'undefined');
      
      // Disable generate button initially
      document.getElementById('generateBtn').disabled = true;
      document.getElementById('generateBtn').innerHTML = 'üì§ Upload CSV First';
    });

    function handleFileUpload(file) {
      if (!file) {
        console.log('No file provided');
        return;
      }

      console.log('File selected:', file.name, file.type, file.size);
      
      // Show loading state
      uploadArea.innerHTML = `
        <div>üì§ Uploading ${file.name}...</div>
        <div style="font-size:12px;color:var(--muted);margin-top:8px">Processing CSV data...</div>
      `;

      // Wait for Papa Parse or use fallback
      waitForPapa().then(papaAvailable => {
        if (papaAvailable) {
          console.log('Using Papa Parse');
          Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            dynamicTyping: false,
            complete: handleParseComplete,
            error: handleParseError
          });
        } else {
          console.log('Papa Parse not available, using fallback');
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const result = parseCSVFallback(e.target.result);
              handleParseComplete(result);
            } catch (error) {
              handleParseError(error);
            }
          };
          reader.readAsText(file);
        }
      });
    }

    function handleParseComplete(results) {
      console.log('Parse complete:', results);
      
      if (results.errors && results.errors.length > 0) {
        console.error('Parse errors:', results.errors);
      }

      if (!results.data || results.data.length === 0) {
        uploadArea.innerHTML = `
          <div style="color:var(--danger)">‚ùå No data found in CSV</div>
          <div style="font-size:12px;color:var(--muted);margin-top:8px">Please check your file has headers and data rows</div>
        `;
        return;
      }

      csvData = results.data;
      console.log('CSV Data loaded:', csvData.length, 'rows');
      console.log('Sample row:', csvData[0]);
      console.log('Headers found:', Object.keys(csvData[0] || {}));
      
      try {
        processedLeads = processCSV(csvData);
        console.log('Processed leads:', processedLeads.length);
        
        updateStats(processedLeads);
        
        uploadArea.innerHTML = `
          <div style="color:var(--success)">‚úÖ ${csvData.length} records loaded successfully!</div>
          <div style="font-size:12px;color:var(--muted);margin-top:8px">${processedLeads.length} leads ready for outreach</div>
          <div style="font-size:11px;color:var(--muted);margin-top:4px">Headers: ${Object.keys(csvData[0] || {}).slice(0, 5).join(', ')}${Object.keys(csvData[0] || {}).length > 5 ? '...' : ''}</div>
        `;

        // Enable generate button
        document.getElementById('generateBtn').disabled = false;
        document.getElementById('generateBtn').innerHTML = 'üöÄ Generate Smart Pitches';
        
      } catch (error) {
        console.error('Processing error:', error);
        uploadArea.innerHTML = `
          <div style="color:var(--danger)">‚ùå Error processing data: ${error.message}</div>
          <div style="font-size:12px;color:var(--muted);margin-top:8px">Please check your CSV format</div>
        `;
      }
    }

    function handleParseError(error) {
      console.error('Parse error:', error);
      uploadArea.innerHTML = `
        <div style="color:var(--danger)">‚ùå Error reading CSV: ${error.message}</div>
        <div style="font-size:12px;color:var(--muted);margin-top:8px">Please ensure it's a valid CSV file</div>
      `;
    }

    // Filter chips functionality
    document.querySelectorAll('.filter-chip').forEach(chip => {
      chip.addEventListener('click', () => {
        const checkbox = chip.querySelector('input');
        checkbox.checked = !checkbox.checked;
        chip.classList.toggle('active', checkbox.checked);
        
        if (processedLeads.length > 0) {
          const filtered = filterLeads(processedLeads);
          renderResults(filtered);
          updateStats(filtered);
        }
      });
    });

    // Filter leads based on selected criteria
    function filterLeads(data) {
      const filters = {
        'no-website': document.querySelector('[data-filter="no-website"] input').checked,
        'weak-website': document.querySelector('[data-filter="weak-website"] input').checked,
        'enhance-website': document.querySelector('[data-filter="enhance-website"] input').checked,
        'poor-performance': document.querySelector('[data-filter="poor-performance"] input').checked
      };

      return data.filter(item => {
        const segment = item.lead.segment;
        const hasIssues = item.analysis.issues.length > 1;

        return (
          (segment === 'no-website' && filters['no-website']) ||
          (segment === 'weak-website' && filters['weak-website']) ||
          (segment === 'professional' && filters['enhance-website']) ||
          (hasIssues && filters['poor-performance'])
        );
      });
    }

    // Generate button
    document.getElementById('generateBtn').addEventListener('click', () => {
      if (processedLeads.length === 0) {
        alert('Please upload a CSV file first!');
        return;
      }

      const filtered = filterLeads(processedLeads);
      renderResults(filtered);
    });

    // Export functionality
    document.getElementById('exportBtn').addEventListener('click', () => {
      if (processedLeads.length === 0) {
        alert('No data to export!');
        return;
      }

      const config = {
        yourName: document.getElementById('yourName').value.trim(),
        yourEmail: document.getElementById('yourEmail').value.trim(),
        ccEmail: document.getElementById('ccEmail').value.trim(),
        companyName: document.getElementById('companyName').value.trim(),
        companyUrl: document.getElementById('companyUrl').value.trim(),
        tone: document.getElementById('emailTone').value
      };

      const exportData = processedLeads.map(item => {
        const subjects = generateSubjects(item.lead, item.analysis);
        const emailBody = generateEmailBody(item.lead, item.analysis, config);
        
        return {
          Name: item.lead.name,
          Email: item.lead.email,
          Website: item.lead.website,
          Industry: item.lead.industry,
          Segment: item.lead.segment,
          'Subject Line 1': subjects[0] || '',
          'Subject Line 2': subjects[1] || '',
          'Subject Line 3': subjects[2] || '',
          'Email Body': emailBody,
          Issues: item.analysis.issues.join('; '),
          Opportunities: item.analysis.opportunities.join('; ')
        };
      });

      const csv = Papa.unparse(exportData);
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `outreach_campaigns_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
